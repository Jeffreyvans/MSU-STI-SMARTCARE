{% extends "basic.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'patient/checkdisease/dps.css' %}">   
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script>
// -------- English Section Functions ----------
function Functionshow() {
  document.getElementById("searchbar").value = '';
  document.getElementById("myDropdown").classList.toggle("show");
  search_symptoms();
}

window.onclick = function(event) {
  if (!event.target.matches('.btn')) {
    if (!event.target.matches('.searchbardiv') && !event.target.matches('.searchbar')){
      var dropdowns = document.getElementsByClassName("drop-content");
      for (let i = 0; i < dropdowns.length; i++) {
        if (dropdowns[i].classList.contains('show')) {
          dropdowns[i].classList.remove('show');
        }
      }
    }
  }
}

function Functionsymptoms(name) {
  var container = document.createElement("span");
  container.setAttribute("class", "badge bg-info text-dark symptom-badge");

  var text = document.createElement("span");
  text.innerText = name;
  text.setAttribute("class","symptoms");
  
  var removeBtn = document.createElement("button");
  removeBtn.innerHTML = "&times;";
  removeBtn.setAttribute("type", "button");
  removeBtn.setAttribute("class", "btn-close btn-sm ms-2");
  removeBtn.onclick = function() {
    container.classList.add("fade-out");
    setTimeout(()=> container.remove(), 300);
  };

  container.appendChild(text);
  container.appendChild(removeBtn);
  document.getElementById("sympbox").appendChild(container);
}

function clearAllSymptoms() {
  document.getElementById("sympbox").innerHTML = "";
}

function search_symptoms() { 
  let input = document.getElementById('searchbar').value.toLowerCase(); 
  let x = document.getElementsByClassName('dropdown-item'); 
  for (let i = 0; i < x.length; i++) {  
      if (!x[i].innerHTML.toLowerCase().includes(input)) { 
          x[i].style.display="none"; 
      } else { 
          x[i].style.display="inline-block";                  
      } 
  } 
} 

$(document).ready(function(){
  $("#predict").click(function (event) {
    event.preventDefault();

    var symptoms = document.getElementsByClassName("symptoms");
    var noofsym = symptoms.length;
    var symlist=[];

    if(noofsym == 0){
      alert("‚ö†Ô∏è Please add some symptoms first!");
    } else {
      for(let i=0;i<symptoms.length;i++){
        symlist[i]=symptoms[i].innerText;
      }

      $("#loading").show();
      $("#resultdiv").hide();

      $.ajax({
        url: 'checkdisease',
        type: "POST",
        data: { 
          "noofsym" : noofsym,
          "symptoms" : symlist,
          csrfmiddlewaretoken : $('input[name=csrfmiddlewaretoken]').val()
        },
        dataType: 'json',

        success: function (data) {
          $("#loading").hide();
          $("#resultdiv").fadeIn("slow");
          $('html,body').animate({
            scrollTop: $("#resultdiv").offset().top},
            'slow');

          document.getElementById('diseasefield').innerText = data["predicted_sti"];
          document.getElementById('percentage').innerText = data["confidencescore"]+"%";
          let percent=data["confidencescore"];
          let disease=data["predicted_sti"];

          $('#percentage').css('width', percent + "%");

          document.getElementById('diseasesearch').innerText = disease;
          $("#href").attr("href","https://www.google.com/search?q="+ disease +"");
          document.getElementById('consultdoctor').innerText = data["consultdoctor"];
        }
      });
    }
  });
});
</script>

<style>
/* Card style */
.card {
  border-radius: 16px;
  box-shadow: 0px 6px 18px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease-in-out;
}
.card:hover {
  transform: scale(1.01);
}

/* Symptom badges */
.symptom-badge {
  display: inline-flex;
  align-items: center;
  margin: 5px;
  font-size: 14px;
  padding: 10px;
  border-radius: 20px;
  transition: all 0.3s ease-in-out;
}
.symptom-badge.fade-out {
  opacity: 0;
  transform: scale(0.8);
}

/* Progress animation */
.progress-bar {
  transition: width 1s ease-in-out;
}

/* Button hover */
.btn {
  transition: all 0.2s ease-in-out;
}
.btn:hover {
  transform: scale(1.05);
  box-shadow: 0px 4px 12px rgba(0,0,0,0.2);
}

/* Spinner center */
#loading {
  display: none;
  text-align: center;
  margin: 20px 0;
}
</style>
{% endblock %}


{% block body %}
<div class="container">

  <!-- Language Switch -->
  <div class="text-center mt-3 mb-4">
    <button class="btn btn-secondary" onclick="document.getElementById('english-section').style.display='block'; document.getElementById('shona-section').style.display='none';">
      üåç Use English Symptoms
    </button> 
  </div>

  <!-- English Section -->
  <div id="english-section" style="display:block;">
    <div class="text-center"> 
      <h3>ü©∫ Identify possible conditions and treatments related to your symptoms</h3><br>
      <button onclick="Functionshow()" class="btn btn-primary dropdown-toggle" data-bs-toggle="tooltip" title="Add your symptoms here">
        <i class="bi bi-plus-circle"></i> Add symptoms
      </button>
    </div>

    <div id="myDropdown" class="drop-content">
      <div id="searchbardiv" class="searchbardiv">    
        <input id="searchbar" class="form-control" onkeyup="search_symptoms()" type="text"
          name="search" placeholder=" üîç Search symptoms.. "> <br>
      </div> 
      <div class="container" id="container-dropdown">
        {% for i in list2 %}
        <a class="dropdown-item" onclick="Functionsymptoms(this.textContent)">{{i}}</a>
        {% endfor %}
      </div>
    </div>
          
    <br><br>
    <div class="text-center">
      <div class="card" id="symptoms-box">
        {% csrf_token %}
        <div class="card-header">üìù Symptoms list</div>
        <div class="card-body" id="sympbox"></div>
        <br>
        <div class="card-footer">
          <button id="predict" class="btn btn-success">
            <i class="bi bi-lightning-fill"></i> Predict
          </button>
          <button onclick="clearAllSymptoms()" class="btn btn-warning ms-2">
            <i class="bi bi-trash"></i> Clear All
          </button>
        </div>
      </div>
    </div>

    <!-- Spinner -->
    <div id="loading">
      <div class="spinner-border text-success"></div>
      <p>Predicting... please wait</p>
    </div>

    <br>

    <div id="resultdiv" style="display: none;" >
      <div class="text-center">
        <div class="card" id="predicted-data">
          <div class="card-body">
            <div>
              <span class="diseasefield">üë§ Patient name : {{ user.patient.name }}</span>
              <span class="diseasefield">&nbsp &nbsp &nbsp üéÇ Age : {{ user.patient.age }}</span>
            </div>
            <hr>
            <span class="diseasefield">ü¶† Predicted condition: </span>
            <span class="diseasefield fw-bold" id="diseasefield" style="color: #092700; text-shadow: 2px 2px 4px rgb(36, 255, 45);"></span> 
            <br><br>

            <span class="diseasefield">üìä Confidence score: </span>
            <span>
              <div class="progress" style="display: inline-block;width:140px">
                <div id="percentage" class="progress-bar bg-success" style="width: 0%">0%</div>
              </div>
            </span>
          </div>
        </div>
      </div>

      <div class="text-center mt-4 mb-4"> 
        <button class="btn btn-outline-success">
          <a id="href" href="https://www.google.com/search?q=anuj" target="_blank" rel="noopener noreferrer">
            üîó Click here to know more about &nbsp 
            <span id="diseasesearch" style="color: crimson;"></span>
          </a>
        </button>
      </div>

      <br><br>
      <div class="text-center">
        <h4>‚ö†Ô∏è This tool does not provide medical advice.</h4>
        <h5>It is intended for informational purposes only, not a substitute for professional medical advice, diagnosis or treatment.</h5>
      </div>

      <br><br>
      <div class="mx-auto text-center " style="width:350px">
        <form action="consult_a_doctor" method="GET">
          {% csrf_token %} 
          <button id="consultbtn" type="submit" class="btn btn-primary">
            ü©∫ Consult a <span id="consultdoctor"  name="consultdoctor" ></span> doctor
          </button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
